<!DOCTYPE html>
<html>
<head>
<script src="jspsych.js"></script>
<script src="jquery-3.6.0.js"></script>
<link rel="stylesheet" href="css/jspsych.css">
<link rel="stylesheet" href="map-locations.css">
<link rel="stylesheet" href="card-flipping_final.css">
<script src="jspsych-spatial-layout-map.js"></script>
<script src="jspsych-instructions-image-and-sound.js"></script>
<script src="plugins/jspsych-survey-html-form.js"></script>
<script src="plugins/jspsych-survey-text.js"></script>
<script src="plugins/jspsych-survey-multi-choice.js"></script>
<script src="plugins/jspsych-survey-multi-select.js"></script>
<script src="plugins/jspsych-survey-likert.js"></script>
<script src="plugins/jspsych-html-keyboard-response.js"></script>
<script src="plugins/jspsych-html-button-response.js"></script>
<script src="plugins/jspsych-video-button-response.js"></script>
<script src="plugins/jspsych-fullscreen.js"></script>
<script src="plugins/jspsych-instructions.js"></script>
<script src="plugins/jspsych-external-html.js"></script>
<script src="jspsych-digit-span-recall.js"></script>
<link href="jspsych_digitspan.css" rel="stylesheet" type="text/css"></link>
</head>
<script>

// *****************************************************************************************************************************************
// Calibration task

positions = [14, 53, 
90, 10,
 14, 26,
  33, 44,
   58, 5, 
   13, 95,
    17, 50,
     64, 83,
      46, 5,
       77, 33]

var calibration_trial = {
    on_start: function(trial){
      trial.button_html = `<button style="background-color: #000000; 
  position: absolute;
  top:` + positions[position_index -1] + `%;
  left: ` +positions[position_index]  +`%;
  border: none;
  color: white;
  padding: 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 50%;"></button>`
    },
    type: 'html-button-response',
    stimulus: '<p></p>',
    choices: ['']
};

var position_index = 1

calibration_timeline = {
  timeline: [calibration_trial],
  loop_function: function(){
    position_index +=2
    if(position_index < positions.length-1){
      return true
    }
    else{
      return false
    }
  }
}

var calibration_instructions = {
  type: "instructions",
  pages: [`Before beginning the experiment, Please have your volume on for this experiment as instructions will be read aloud.`,
  `Before we start, please practice using your mouse by clicking on the black circles as they show up on your screen. <br>
Try to click as fast as you can when a circle appears. <br> But be careful! Try not to click outside the circles!
`],
show_clickable_nav: true,
allow_backward: false
}


// ==========================================================================================================================================
// Main task - spatial layout card game experiment

    E = ["stimuli/shoes.png",
    "stimuli/shirt.png",
    "stimuli/car.png",
    "stimuli/fish.png",
    "stimuli/pig.png",
    "stimuli/cat.png",
    "stimuli/horse.png",
    "stimuli/strawberry.png",
    "stimuli/milk.png",
    "stimuli/banana.png",
    "stimuli/plant.png",
    "stimuli/shovel.png",
    "stimuli/bell.png",
    "stimuli/toothbrush.png",
    "stimuli/pencil.png",
    "stimuli/baseball bat.png"]

    F = ["stimuli/sock.png",
    "stimuli/pants.png",
    "stimuli/bus.png",
    "stimuli/bird.png",
    "stimuli/chicken.png",
    "stimuli/dog.png",
    "stimuli/bunny.png",
    "stimuli/watermelon.png",
    "stimuli/egg.png",
    "stimuli/orange.png",
    "stimuli/tree.png",
    "stimuli/broom.png",
    "stimuli/clock.png",
    "stimuli/spoon.png",
    "stimuli/crayons.png",
    "stimuli/ball.png"]

    G = ["stimuli/shoes.png",
    "stimuli/pants.png",
    "stimuli/car.png",
    "stimuli/bird.png",
    "stimuli/chicken.png",
    "stimuli/dog.png",
    "stimuli/horse.png",
    "stimuli/watermelon.png",
    "stimuli/milk.png",
    "stimuli/banana.png",
    "stimuli/tree.png",
    "stimuli/shovel.png",
    "stimuli/bell.png",
    "stimuli/spoon.png",
    "stimuli/pencil.png",
    "stimuli/ball.png"]

    H = ["stimuli/sock.png",
    "stimuli/shirt.png",
    "stimuli/bus.png",
    "stimuli/fish.png",
    "stimuli/pig.png",
    "stimuli/cat.png",
    "stimuli/bunny.png",
    "stimuli/strawberry.png",
    "stimuli/egg.png",
    "stimuli/orange.png",
    "stimuli/plant.png",
    "stimuli/broom.png",
    "stimuli/clock.png",
    "stimuli/toothbrush.png",
    "stimuli/crayons.png",
    "stimuli/baseball bat.png"]

    image_set = [E,F, G, H]

    practice_set = ["stimuli/practice stimuli/box.png",
    "stimuli/practice stimuli/brush.png",
    "stimuli/practice stimuli/crown.png",
    "stimuli/practice stimuli/cup.png",
    "stimuli/practice stimuli/dice.png",
    "stimuli/practice stimuli/duck.png"]

    var video1 = 'stimuli/videos/start to blue.mp4'
    var video2 = 'stimuli/videos/blue to orange.mp4'

    


  function shuffle(array) {
  var currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

    function create_timeline_variables(){
      var group = jsPsych.data.getURLVariable('exp')
      var phase1_variables = []
      var phase2_variables = []
      var test_variables = []
      if(group == '1'){
        var set1 = shuffle(E)
        var set2 = shuffle(F)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '2'){
        var set1 = shuffle(F)
        var set2 = shuffle(E)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '3'){
        var set1 = shuffle(G)
        var set2 = shuffle(H)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false}),
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '4'){
        var set1 = shuffle(H)
        var set2 = shuffle(G)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '5'){
        var set1 = shuffle(F)
        var set2 = shuffle(E)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      if(group == '6'){
        var set1 = shuffle(E)
        var set2 = shuffle(F)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      if(group == '7'){
        var set1 = shuffle(H)
        var set2 = shuffle(G)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      if(group == '8'){
        var set1 = shuffle(G)
        var set2 = shuffle(H)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      console.log([phase1_variables, phase2_variables, test_variables])
      return [phase1_variables, phase2_variables, test_variables]
    }


  var fullscreen=  {
  type: 'fullscreen',
  fullscreen_mode: true
}


var instructions1 = {
  type: 'instructions-image-and-sound',
  pages: ['instructions/Screenshot (195).png',
  'instructions/Screenshot (196).png', 
  'instructions/Screenshot (197).png', 
  'instructions/Screenshot (198).png', 
  'instructions/Screenshot (199).png'], 
  audio: ['recordings/SLP Instruction Recordings/SLP_2new.mp3',
  'recordings/SLP Instruction Recordings/SLP_3.mp3',
  'recordings/SLP Instruction Recordings/SLP_4.mp3',
  'recordings/SLP Instruction Recordings/SLP_5.mp3',
  'recordings/SLP Instruction Recordings/SLP_6.mp3'
],
  show_clickable_nav: true
}


var pre_task1 = {
  type: 'instructions-image-and-sound',
  pages: [`instructions/Screenshot (200).png`],
  audio:['recordings/SLP Instruction Recordings/SLP_7.mp3'],
  show_clickable_nav: true
}

var post_task1 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if (["1","3", "5", "7"].includes(group)){
      trial.pages = [`instructions/Screenshot (214).png`]
    }
    else if (["2","4", "6", "8"].includes(group)){
      trial.pages = [`instructions/Screenshot (212).png`]
    }
  },
  type: 'instructions-image-and-sound',
  audio:['recordings/SLP Instruction Recordings/SLP_7.mp3'],
  show_clickable_nav: true
}


var instructions2 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["2","4", "5", "7"].includes(group)){
      trial.pages = [`instructions/Screenshot (209).png`,
    `instructions/Screenshot (211).png`]
      trial.audio = ['recordings/SLP Instruction Recordings/SLP_18.mp3',
      'recordings/SLP Instruction Recordings/SLP_19.mp3']}
    else if(["1","3", "6", "8"].includes(group)){
    trial.pages= [`instructions/Screenshot (208).png`,
    `instructions/Screenshot (210).png`]
    trial.audio = ['recordings/SLP Instruction Recordings/SLP_17.mp3', 
      'recordings/SLP Instruction Recordings/SLP_19.mp3']
  }},
  type: 'instructions-image-and-sound',
  show_clickable_nav: true
}

var post_task2 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if (["1","2", "3", "4"].includes(group)){
      trial.pages = [`instructions/Screenshot (201).png`]
    }
    else if (["5","6", "7", "8"].includes(group)){
      trial.pages = [`instructions/Screenshot (202).png`]
    }
  },
  type: 'instructions-image-and-sound',
  audio:['recordings/SLP Instruction Recordings/SLP_21+23.mp3'],
  show_clickable_nav: true
}


var instructions_test = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if (["1","2", "3", "4"].includes(group)){
      trial.pages = [`instructions/Screenshot (215).png`]
    }
    else if (["5","6", "7", "8"].includes(group)){
      trial.pages = [`instructions/Screenshot (213).png`]
    }
  },
  type: 'instructions-image-and-sound',
  audio:['recordings/SLP Instruction Recordings/SLP_22+24.mp3'],
  show_clickable_nav: true
}

var goodbye = {
  type: 'instructions-image-and-sound',
  pages: [`instructions/Screenshot (216).png`],
  audio:['recordings/SLP Instruction Recordings/SLP_26.mp3'],
  show_clickable_nav: true
}


  var video_transition_start = {
    type: 'video-button-response',
    stimulus: [ "stimuli/videos/start to pink.mp4"
      ],
    width: 1400,
    height: 800,
    response_ends_trial: true,
    response_allowed_while_playing: false, 
    choices: ['Enter the world']
  }

  var video_transition1 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["1","2","3","4"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to blue.mp4"]
    }
    else if(["5","6","7","8"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to orange.mp4"]
    }
  },
  type: 'video-button-response',
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Enter the world']
}

var video_transition_delay = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["1","2","3","4"].includes(group)){
      trial.stimulus = ["stimuli/videos/blue to pink.mp4"]
    }
    else if(["5","6","7","8"].includes(group)){
      trial.stimulus = ["stimuli/videos/orange to pink.mp4"]
    }
  },
  type: 'video-button-response',
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Enter the world']
}

var video_transition2 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["2","4", "6", "8"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to orange.mp4"]
    }
    else if(["5","7", "1", "3"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to blue.mp4"]}
  },
  type: 'video-button-response',
  stimulus: [ video2
    ],
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Enter the world']
}

var video_transition_3_trial = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["2","4"].includes(group)){
      trial.stimulus = ["stimuli/videos/orange to blue.mp4"]
    }
    else if(["5","7"].includes(group)){
      trial.stimulus = ["stimuli/videos/blue to orange.mp4"]}
  },
  type: 'video-button-response',
  stimulus: [ video2
    ],
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Enter the world']
}

var video_transition_3 = {
  timeline: [video_transition_3_trial],
  conditional_function: function(){
    var group = jsPsych.data.getURLVariable('exp')
    if(["2","4", "5", "7"].includes(group)){
      return true
    }
    else{
      return false
    }
  }
}

var count_repetitions = 1

    var map_trial = {
    on_start: function(trial){
      if (count_repetitions <=  15){
      trial.data = {repetition: count_repetitions}}
      else{
        trial.data = {repetition: count_repetitions, exclusion: true}
      }
    },
    type: 'spatial-layout-map',
    background: jsPsych.timelineVariable('map'),
    background_height: 800,
    background_width: 1400, 
    images: jsPsych.timelineVariable('image_set'),
    correct_response: jsPsych.timelineVariable('correct_response'),
    button_image: 'stimuli/black_card.png',
    disabled_button_image: 'stimuli/grey_card.png',
    overlapping: jsPsych.timelineVariable('overlapping'),
    layout: jsPsych.timelineVariable('layout'),
    card_height: 120,
    card_width: 75,
    response_ends_trial: false,
    correct_sound: 'stimuli/correct_sound.wav',
    test: jsPsych.timelineVariable('test'),
    on_finish: function(data){
      console.log(data)
    }}



    var practice = {
    timeline: [map_trial], 
    data: {phase: "practice main task"},
    timeline_variables: [{correct_response: practice_set[0], image_set: practice_set, map: 'stimuli/pink world.png', 
          overlapping: false, layout: 'P', test: false},
          {correct_response: practice_set[1], image_set: practice_set, map: 'stimuli/pink world.png', 
          overlapping: false, layout: 'P', test: false}],
    randomize_order: true}

    var count_perfect_reps = 0

    var phase1 = {
    timeline: [map_trial],
    timeline_variables: create_timeline_variables()[0],
    randomize_order: true,
    data: {phase: "phase1"},
    loop_function: function(data){ 
        count_repetitions +=1
        console.log(jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count())
        if (jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count() == 16){
          count_perfect_reps +=1
        }
        else{
          count_perfect_reps = 0
        }
        console.log(count_perfect_reps)
        if(count_perfect_reps == 2){
            count_repetitions = 1
            return false;}
        else if (count_repetitions >= 15){
          count_repetitions = 1
          return false;
        }
        else {
            return true;
        }}}
    
    var phase2 = {
    timeline: [map_trial], 
    timeline_variables: create_timeline_variables()[1],
    randomize_order: true,
    data: {phase: "phase2"},
    loop_function: function(data){ 
        count_repetitions +=1
        console.log(jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count())
        if (jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count() == 16){
          count_perfect_reps +=1
        }
        else{
          count_perfect_reps = 0
        }
        console.log(count_perfect_reps)
        if(count_perfect_reps == 2){
            return false;
        } else {
            return true;
        }}}
    

    var test = {
    timeline: [map_trial],
    data: {phase: "test"}, 
    timeline_variables: create_timeline_variables()[2],
    randomize_order: true}

// ===========================================================================================================================================
// Delay task - digit span backwards 

  // first two numbers in number_set are practice
  number_set = ["21","75", "14", "62", "185", "814", "9518", "374x", 
"48913", "19485", "9648x1", "529483", "6394x18", "2536x149", "165983648"]

// instruction page
var instructions_delay_task = {
    type: 'instructions-image-and-sound',
    pages: ['instructions/Screenshot (203).png',
  'instructions/Screenshot (204).png', 
  'instructions/Screenshot (205).png'],
    audio: ['recordings/SLP Instruction Recordings/SLP_12.mp3',
  'recordings/SLP Instruction Recordings/SLP_13.mp3',
  'recordings/SLP Instruction Recordings/SLP_14.mp3'],
    show_clickable_nav: true
  }

  var pre_delay_task = {
    type: 'instructions-image-and-sound',
    pages: ['instructions/Screenshot (206).png'],
    audio: ['recordings/SLP Instruction Recordings/SLP_15.mp3'],
    show_clickable_nav: true
  }

  var post_delay_task = {
    type: 'instructions-image-and-sound',
    pages: ['instructions/Screenshot (207).png'],
    audio: ['recordings/SLP Instruction Recordings/SLP_16.mp3'],
    show_clickable_nav: true
  }

  var digit_index = 0

var test_stimuli = {
  type: 'html-keyboard-response',
  stimulus: function(){
    var number = number_set[number_set_index]
    var digit = number[digit_index]
    if (digit == "x"){
      digit = "10"
    }
    var stimuli =  '<div style="font-size:70px;">'+digit+'</div>'
    return stimuli
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000
  }

var display_digits = {
    timeline: [test_stimuli],
    repetitions: 1,
    loop_function: function(data){
        while(digit_index + 1 != number_set[number_set_index].length){
            digit_index += 1
            return true
    }
    digit_index = 0
    return false
}
}

function reverseString(str) {
    var newString = "";
    for (var i = str.length - 1; i >= 0; i--) {
        newString += str[i];
    }
    return newString;
}

var scores = [0,0]

var recall = {
  type: 'digit-span-recall',
  correct_order: function(){
    return reverseString(number_set[number_set_index])
  },
  trial_duration: null,
  sound: "stimuli/button_click_sound.mp4",
  on_finish: function(data){
      var stimuli = reverseString(number_set[number_set_index])
      console.log(stimuli)
      console.log(data.recall)
      var score = 0
      for (i = 0; i < number_set[number_set_index].length; i++){
        console.log("i = " + i)
        console.log(data.recall[i])
        console.log(stimuli[i])
        if(typeof data.recall[i] === 'undefined') {
          console.log("undefined")
              break;
        // does not exist
        }
        else {
        // does exist
        console.log(data.recall[i] == stimuli[i])
        if (data.recall[i] == stimuli[i]){
            score +=1
        }
        }
            }
        data.score = score
        scores.push(score)
        console.log(score)
        console.log(scores)
}}

var feedback = {
  type: 'html-keyboard-response',
  stimulus: function(){
    var text = ""
    var accuracy = jsPsych.data.get().last(1).values()[0].accuracy
    if (accuracy==1){
      text += '<div style="font-size:35px; color:rgb(0 220 0)"><b>Correct</div>'
    } else {
      text += '<div style="font-size:35px; color:rgb(240 0 0)"><b>Incorrect</div>'
    }
    //text += '<div style="font-size:30px; color:rgb(0 0 0)"><br><br>New trial starting now.</div>'
    return text
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000
}

var number_set_index = 0

var practice_timeline = {
  timeline: [display_digits, recall, feedback],
  repetitions: 1,
  data: {phase: "practice delay"},
  loop_function: function(data){
    number_set_index +=1
    while(number_set_index != 2){
      return true
    }
    return false
}}

var delay_task_timeline = {
  timeline: [display_digits, recall, feedback],
  repetitions: 1,
  data: {phase: "delay task"},
  loop_function: function(data){
    console.log(scores[scores.length-1] , scores[scores.length-2] )
    while(number_set_index+1 != number_set.length && ( number_set_index < 7 || (scores[scores.length-1] > 3 || scores[scores.length-2] > 3 ))){
        number_set_index +=1
        return true
    }
    return false
  }
}

digit_span_backwards = {
  timeline: [instructions_delay_task, practice_timeline, pre_delay_task, delay_task_timeline]
}

//===========================================================================================================================================
// Post Experiment Questionnaire

var first_question_options = [`A mouse`,
`A trackpad`,
`Touch screen`, "other"
];

first_question = {
  data: {phase: 'PEQ'},
  type: 'survey-multi-choice',
  reamble: '<b> Post Experiment Questionnaire</b>',
  questions: [
    {prompt: `<b> 1. For the card game tasks, what did you use to select the cards?</b>
`, options: first_question_options, required: true, horizontal: false, name: '1'}
  ]}

var second_question = {
  type: 'survey-text',
  preamble: '<b>2. In the card game tasks, what was your strategy when learning where the objects were located?</b>',
  data: {phase: 'PEQ'},
  questions: [
    {prompt: "a) First card game:", rows: 5, columns: 40, name: '2a', required: true},
    {prompt: "b) Second card game:", rows: 5, columns: 40, name: '2b', required: true}
  ],
};

questions_three_four = {
  data: {phase: 'PEQ'},
  type: 'survey-multi-choice',
  questions: [
    {prompt: `In the second card game, were you thinking of the cards you learned in the first card game?
`, options: ['Yes', 'No'], required: true, horizontal: false,  name: '3'},{
prompt: `If yes, did this help or distract you?
`, options: ['It helped me', 'It distracted me', 'It had no effect'], required: true, horizontal: false, name: '4'
}
  ]  
}

var question_four_part_two = { 
  type: 'survey-text',
  data: {phase: 'PEQ'},
  questions: [
    {prompt: "Tell us more:", rows: 5, columns: 40, name: '4b', required: false}  ],
};

question_six = {
  type: 'survey-text',
  data: {phase: 'PEQ'},
  questions: [
    {prompt: ` <b> 6. List the tasks from easiest to hardest. </b> <br> <br>
      <b>(a)</b> First card game <b>  (b)</b> Number task <b>  (c)</b> Second card game <b>  (d)</b> Final card memory test <br>
e.g. c, a, b, d`, rows: 1, columns: 5, name: '6', required: true}
  ]
}

question_seven = {
  type: 'survey-text',
  data: {phase: 'PEQ'},
  questions: [
    {prompt: "<b> 6. Do you have any other comments?</b>", rows: 5, columns: 40, name: 'First card game', required: false, name: '6'}
  ],
}

PEQ = {
  timeline: [first_question, second_question, questions_three_four, question_four_part_two, question_six, question_seven]
}

// ==========================================================================================================================================
// Sending data and forms

function generate_uuid() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}
    
        var send_data = {
        type: 'html-keyboard-response',
        stimulus: 'Saving responses... <br> <br> Do NOT exit the page.',
        choices: jsPsych.NO_KEYS,
        trial_duration: null,
        on_start: function(trial){
          
          var subject_id = generate_uuid()

          var start_time = new Date();

          // get url info
          var url_data = jsPsych.data.urlVariables();


          var phase1_responses = jsPsych.data.get().filter([{phase: 'phase1'}]);
          var phase1_data = {'phase': 'phase1', 'data': phase1_responses.values()};

          var phase2_responses = jsPsych.data.get().filter([{phase: 'phase2'}]);
          var phase2_data = {'phase': 'phase2', 'data': phase2_responses.values()};

          var test_responses = jsPsych.data.get().filter([{phase: 'test'}]);
          var test_data = {'phase': 'test', 'data': test_responses.values()};

          var delay_responses = jsPsych.data.get().filter([{phase: 'delay task'}]);
          var delay_data = {'phase': 'delay task', 'data': delay_responses.values()};

          var PEQ_responses = jsPsych.data.get().filter([{phase: 'PEQ'}]);
          var PEQ_data = {'phase': 'PEQ', 'data': PEQ_responses.values()};

            // organize data into sections
            var end_time = new Date();
            var duration = ((end_time - start_time)/60000).toFixed(2);
            
            var data = {
                /*prolific_id: url_data.PROLIFIC_PID,
                study_id: url_data.STUDY_ID,
                session_id: url_data.SESSION_ID,*/
                experiment: "Spatial_layout",
                repo: "buddingmindslab.github.io",
                subject: subject_id,
                duration: duration,
                date: Date(),
                counterbalancing_group: url_data.exp,
                data: [
                  phase1_data,
                  phase2_data,
                  test_data,
                  delay_data,
                  PEQ_data
                ]
            }

            // send data to savejs
            var xhr = new XMLHttpRequest();
            xhr.open('POST','https://savejs.netlify.app/.netlify/functions/savejs');
            xhr.setRequestHeader('Content-Type','application/json');
            xhr.onload = function(){
                if(xhr.status==200){
                    var response=JSON.parse(xhr.responseText);
                    console.log(response.success);
                }
                else {
                    console.log("failed to send data");
                }
            };
            xhr.send(JSON.stringify(data));
            console.log("success sending data");
            trial.trial_duration = 50000
        }
    }


  /********************************************* Conclusion and Debriefing *********************************************/
  var conclusion = {
        type: 'html-button-response',
        choices: ['Continue'],
        stimulus:  "<div style='font-size:20px;'> Congratulations - you have finished the questionnaire! <br> <br> Please proceed to the debriefing. You will only receive your compensation after clicking <I> Complete the session </I> on the following page.",
        trial_duration: null,
    };  

    // debriefing
    var debriefing = {
      on_start: function(trial){
        var group = jsPsych.data.getURLVariable('exp')
        if(["2","4", "5", "7"].includes(group)){
          trial.url = 'debriefing/debriefing_non_overlapping.html'
        }
        else if(["1","3", "6", "8"].includes(group)){
          trial.url = 'debriefing/debriefing_overlapping.html'
      }},
        type: 'external-html',
        url: 'debriefing/debriefing.html',
        cont_btn: "start",
        data: {phase: 'debriefing'}
    }
    
    // thank you
    var end_experiment = {
        type: 'html-keyboard-response',
        stimulus: '<p style="font-size:300%; line-height:1.0">Thank you for your participation!</p>',
        trial_duration: 1000,
        choices: jsPsych.ANY_KEYS
    }

    /***************************************************************************************************************************/
    
var consent = null

var check_consent = function(elem) {
  if (document.getElementById('agree_checkbox').checked) {
    return true;
  }
  else {
    alert("If you wish to participate, you must check the box next to the statement 'I agree'");
    return false;
  }
  return false;
};

var consent_page = {
        type: 'external-html',
        url: 'consent.html',
        cont_btn: "start",
        data: {phase: 'consent_form'},
        check_fn: check_consent
    }

    var experiment_timeline = [fullscreen, consent_page, calibration_instructions, calibration_timeline, video_transition_start, instructions1, practice, pre_task1, video_transition1, phase1,post_task1 ,video_transition_delay,
  instructions_delay_task, practice_timeline,pre_delay_task ,delay_task_timeline, post_delay_task, instructions2, video_transition2, phase2, post_task2, video_transition_3,
instructions_test, test, goodbye, PEQ, send_data, conclusion, debriefing, end_experiment]


    jsPsych.init({
    timeline: experiment_timeline,
    preload_images: E.concat(F).concat(practice_set).concat(["stimuli/yellow world.png","stimuli/blue world.png","stimuli/pink world.png",
   "stimuli/instructions.PNG", "stimuli/instructions2.jpg", "stimuli/instructions_non_overlapping.png", 
   "stimuli/instructions_overlapping.png", "stimuli/instructions_pass_card.png"]),
    max_load_time: 180000,
    on_finish: function() { 
      jsPsych.data.displayData("json")
      /*window.location.replace("https://app.prolific.co/submissions/complete?cc=11D45801")*/
            }  
        });
</script>
</html>
