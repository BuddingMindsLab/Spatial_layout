<!DOCTYPE html>
<html>
<head>
<script src="jspsych.js"></script>
<script src="jquery-3.6.0.js"></script>
<link rel="stylesheet" href="css/jspsych.css">
<link rel="stylesheet" href="map-locations.css">
<link rel="stylesheet" href="card-flipping_final.css">
<script src="jspsych-spatial-layout-map.js"></script>
<script src="plugins/jspsych-html-keyboard-response.js"></script>
<script src="plugins/jspsych-html-button-response.js"></script>
<script src="plugins/jspsych-video-button-response.js"></script>
<script src="plugins/jspsych-fullscreen.js"></script>
<script src="plugins/jspsych-instructions.js"></script>
<script src="plugins/jspsych-external-html.js"></script>
<script src="jspsych-digit-span-recall.js"></script>
<link href="jspsych_digitspan.css" rel="stylesheet" type="text/css"></link>
</head>
<script>

// ==========================================================================================================================================
// Main task - spatial layout card game experiment

    E = ["stimuli/shoes.png",
    "stimuli/shirt.png",
    "stimuli/car.png",
    "stimuli/fish.png",
    "stimuli/pig.png",
    "stimuli/cat.png",
    "stimuli/horse.png",
    "stimuli/strawberry.png",
    "stimuli/milk.png",
    "stimuli/banana.png",
    "stimuli/plant.png",
    "stimuli/shovel.png",
    "stimuli/bell.png",
    "stimuli/toothbrush.png",
    "stimuli/pencil.png",
    "stimuli/baseball bat.png"]

    F = ["stimuli/sock.png",
    "stimuli/pants.png",
    "stimuli/bus.png",
    "stimuli/bird.png",
    "stimuli/chicken.png",
    "stimuli/dog.png",
    "stimuli/bunny.png",
    "stimuli/watermelon.png",
    "stimuli/egg.png",
    "stimuli/orange.png",
    "stimuli/tree.png",
    "stimuli/broom.png",
    "stimuli/clock.png",
    "stimuli/spoon.png",
    "stimuli/crayons.png",
    "stimuli/ball.png"]

    G = ["stimuli/shoes.png",
    "stimuli/pants.png",
    "stimuli/car.png",
    "stimuli/bird.png",
    "stimuli/chicken.png",
    "stimuli/dog.png",
    "stimuli/horse.png",
    "stimuli/watermelon.png",
    "stimuli/milk.png",
    "stimuli/banana.png",
    "stimuli/tree.png",
    "stimuli/shovel.png",
    "stimuli/bell.png",
    "stimuli/spoon.png",
    "stimuli/pencil.png",
    "stimuli/ball.png"]

    H = ["stimuli/sock.png",
    "stimuli/shirt.png",
    "stimuli/bus.png",
    "stimuli/fish.png",
    "stimuli/pig.png",
    "stimuli/cat.png",
    "stimuli/bunny.png",
    "stimuli/strawberry.png",
    "stimuli/egg.png",
    "stimuli/orange.png",
    "stimuli/plant.png",
    "stimuli/broom.png",
    "stimuli/clock.png",
    "stimuli/toothbrush.png",
    "stimuli/crayons.png",
    "stimuli/baseball bat.png"]

    image_set = [E,F, G, H]

    practice_set = ["stimuli/practice stimuli/box.png",
    "stimuli/practice stimuli/brush.png",
    "stimuli/practice stimuli/crown.png",
    "stimuli/practice stimuli/cup.png",
    "stimuli/practice stimuli/dice.png",
    "stimuli/practice stimuli/duck.png"]

    var video1 = 'stimuli/videos/start to blue.mp4'
    var video2 = 'stimuli/videos/blue to orange.mp4'

    


  function shuffle(array) {
  var currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

    function create_timeline_variables(){
      var group = jsPsych.data.getURLVariable('exp')
      var phase1_variables = []
      var phase2_variables = []
      var test_variables = []
      if(group == '1'){
        var set1 = shuffle(E)
        var set2 = shuffle(F)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '2'){
        var set1 = shuffle(F)
        var set2 = shuffle(E)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '3'){
        var set1 = shuffle(G)
        var set2 = shuffle(H)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false}),
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '4'){
        var set1 = shuffle(H)
        var set2 = shuffle(G)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/blue world.png', 
          overlapping: false, layout: 'B', test: true})
      }}
      if(group == '5'){
        var set1 = shuffle(F)
        var set2 = shuffle(E)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      if(group == '6'){
        var set1 = shuffle(E)
        var set2 = shuffle(F)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      if(group == '7'){
        var set1 = shuffle(H)
        var set2 = shuffle(G)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/blue world.png', 
          overlapping: true, layout: 'B', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      if(group == '8'){
        var set1 = shuffle(G)
        var set2 = shuffle(H)
        for (var i = 0; i < set1.length; i++){
          phase1_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: false})
          phase2_variables.push({correct_response: set2[i], image_set: set2, map: 'stimuli/yellow world.png', 
          overlapping: true, layout: 'Y', test: false})
          test_variables.push({correct_response: set1[i], image_set: set1, map: 'stimuli/yellow world.png', 
          overlapping: false, layout: 'Y', test: true})
      }}
      console.log([phase1_variables, phase2_variables, test_variables])
      return [phase1_variables, phase2_variables, test_variables]
    }


  var fullscreen=  {
  type: 'fullscreen',
  fullscreen_mode: true
}

overview = {
  type: 'instructions',
  pages: [`<div style='font-size:20px;'>Hi there! Thank you for participating in our study. <br>
In this experiment, you will follow a blue monster as it takes you to different worlds with different tasks. <br> <br>
<img src= stimuli/icon.png width="167" height="167"> </div>`,` <h1> Overview </h1> <ol style='font-size:20px; text-align:left; '>
  <li>For the first task, you will play a card game where you learn where to find objects on the other side of face-down cards.</li>
  <li>For the second activity, you will report back sequences of numbers in reverse order.</li>
  <li>For the third task, you will play a card game similar to the first.</li>
  <li>Finally, in the last activity, you will go back to the world of the first task and test your memory.</li>
</ol>`,`<div style='font-size:20px;'>
It is important that you pay attention and try your best throughout each task. <br> Please read the following more detailed instructions carefully.
`],
show_clickable_nav: true
}


var instructions1 = {
  type: 'instructions',
  pages: [`<div style='font-size:20px;'> Welcome to the card game task! <br> 
     In this task, you will see a target object on the right and cards on the left. <br> There is a unique object on the back of each card, which you can see by clicking the card with your mouse. <br> <br>
     <img src= stimuli/instructions3.png width="60%" height="50%">
     <div style='font-size:20px;'>  Your job is to search for the target object shown on the right amongst the cards.`, 
      ` <div style='font-size:20px;'> When you correctly identify the card that has the target object on it (e.g. the house), <br> a new object will show up on the right (e.g. the door), and it will be your job to find that one next. </div>
      <img src= stimuli/instructions_pass_card.png width="60%" height="50%">
      <div style='font-size:20px;'>  Your goal is to learn where all the objects are located as quickly as possible.`, ` <div style='font-size:20px;'>  At the beginning of the task, you will be mostly guessing. <br> <b> That is okay</b>, make your best guess until you locate the correct object.  <br> Once you have learned where all the objects are, you will move on to the next activity. <br> <br>
Before starting the main task, please complete a brief practice session.`],
  show_clickable_nav: true
}

var pre_task = {
  type: 'instructions',
  pages: [`<div style='font-size:20px;'>Practice trials are done. Great job! Now, you will start the real task.`],
  show_clickable_nav: true
}



var instructions2 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["2","4", "5", "7"].includes(group)){
      trial.pages = [`<div style='font-size:20px;'>
      Great work! You have finished the number sequence task. <br> <br>
      For the third activity, you are going to move to a new world you haven't seen before! <br>`,`
      <div style='font-size:20px;'>In this world, you will play a card game similar to the one you completed in the first task. <br> However, this time you will see some greyed-out cards along with black cards. <br>
         <br> These grey cards won’t flip over, but you will be able to flip the black cards to see the objects underneath. <br> <br>
             <img src= stimuli/instructions_non_overlapping.png width="60%" height="50%">
    <div style='font-size:20px;'> Your job is the same as before - to find the objects under the black cards as they show up on the right.  <br> The goal is to learn where all the new objects are located as quickly as possible.
`, `<div style='font-size:20px;'> Press next to start the game.`]}
    else if(["1","3", "6", "8"].includes(group)){
    trial.pages= [`<div style='font-size:20px;'>
      Great work! You have finished the number sequence task. <br> <br>
      For the third activity, you are going to come back to the same world you were in for the first card game. <br>`,`
      <div style='font-size:20px;'>This time, new black cards will be added to the map along with the cards you saw before. <br> 
        The cards you saw before are now grey and cannot be flipped over. <br> <br> 
    <img src= stimuli/instructions_overlapping.png width="60%" height="50%">
    <div style='font-size:20px;'> Your job is the same as before - to find the objects under the black cards as they show up on the right.  <br> The goal is to learn where all the new objects are located as quickly as possible.
`, `<div style='font-size:20px;'> Press next to start the game.`]
  }},
  type: 'instructions',
  show_clickable_nav: true
}

test = `
You will have as long as you need to make your choice. If after a few seconds you cannot remember where the object is, make your best guess.
`

var instructions_test = {
  type: 'instructions',
  pages: [`<div style='font-size:20px;'>
    Good work! You have finished the second card game. <br> <br>
    In this final task, you will go back to the first world you visited but this time none of the cards will flip over.<br> <br>
    You will still see target objects appear on the right, and you need to click the card where you think the matching object is with your mouse. <br> <br>
    You will only have <b> one chance </b> to select the correct card. <br> <br>
    These cards are the same ones you saw in the first card game, so you need to try and remember where you saw each object. <br>`,`
    <div style='font-size:20px;'> You will have as long as you need to make your choice. <br>
     If you feel like you do not know the correct answer, make your best guess. <br> <br>
     Press next to start.`],
  show_clickable_nav: true
}

var goodbye = {
  type: 'instructions',
  pages: [`<h1 style="font-size: 25px"> Congratulations - you have finished the task! </h1>`],
  show_clickable_nav: true
}


  var video_transition_start = {
    type: 'video-button-response',
    stimulus: [ "stimuli/videos/start to pink.mp4"
      ],
    width: 1400,
    height: 800,
    response_ends_trial: true,
    response_allowed_while_playing: false, 
    choices: ['Continue']
  }

  var video_transition1 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["1","2","3","4"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to blue.mp4"]
    }
    else if(["5","6","7","8"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to orange.mp4"]
    }
  },
  type: 'video-button-response',
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Continue']
}

var video_transition_delay = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["1","2","3","4"].includes(group)){
      trial.stimulus = ["stimuli/videos/blue to pink.mp4"]
    }
    else if(["5","6","7","8"].includes(group)){
      trial.stimulus = ["stimuli/videos/orange to pink.mp4"]
    }
  },
  type: 'video-button-response',
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Continue']
}

var video_transition2 = {
  on_start: function(trial){
    var group = jsPsych.data.getURLVariable('exp')
    if(["2","4", "6", "8"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to orange.mp4"]
    }
    else if(["5","7", "1", "3"].includes(group)){
      trial.stimulus = ["stimuli/videos/pink to blue.mp4"]}
  },
  type: 'video-button-response',
  stimulus: [ video2
    ],
  width: 1400,
  height: 800,
  response_ends_trial: true,
  response_allowed_while_playing: false, 
  choices: ['Continue']
}

var count_repetitions = 1

    var map_trial = {
    on_start: function(trial){
      if (count_repetitions <=  10){
      trial.data = {repetition: count_repetitions}}
      else{
        trial.data = {repetition: count_repetitions, exclusion: true}
      }
    },
    type: 'spatial-layout-map',
    background: jsPsych.timelineVariable('map'),
    background_height: 800,
    background_width: 1400, 
    images: jsPsych.timelineVariable('image_set'),
    correct_response: jsPsych.timelineVariable('correct_response'),
    button_image: 'stimuli/black_card.png',
    disabled_button_image: 'stimuli/grey_card.png',
    overlapping: jsPsych.timelineVariable('overlapping'),
    layout: jsPsych.timelineVariable('layout'),
    card_height: 120,
    card_width: 75,
    response_ends_trial: false,
    correct_sound: 'stimuli/correct_sound.wav',
    test: jsPsych.timelineVariable('test'),
    on_finish: function(data){
      console.log(data)
    }}



    var practice = {
    timeline: [map_trial], 
    data: {phase: "practice main task"},
    timeline_variables: [{correct_response: practice_set[0], image_set: practice_set, map: 'stimuli/pink world.png', 
          overlapping: false, layout: 'P', test: false},
          {correct_response: practice_set[1], image_set: practice_set, map: 'stimuli/pink world.png', 
          overlapping: false, layout: 'P', test: false}],
    randomize_order: true}

    var count_perfect_reps = 0

    var phase1 = {
    timeline: [map_trial],
    timeline_variables: create_timeline_variables()[0],
    randomize_order: true,
    data: {phase: "phase1"},
    loop_function: function(data){ 
        count_repetitions +=1
        console.log(jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count())
        if (jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count() == 16){
          count_perfect_reps +=1
        }
        else{
          count_perfect_reps = 0
        }
        console.log(count_perfect_reps)
        if(count_perfect_reps == 2){
            count_repetitions = 1
            return false;
        } else {
            return true;
        }}}
    
    var phase2 = {
    timeline: [map_trial], 
    timeline_variables: create_timeline_variables()[1],
    randomize_order: true,
    data: {phase: "phase2"},
    loop_function: function(data){ 
        count_repetitions +=1
        console.log(jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count())
        if (jsPsych.data.getLastTimelineData().filter({"number of touches": 1}).count() == 16){
          count_perfect_reps +=1
        }
        else{
          count_perfect_reps = 0
        }
        console.log(count_perfect_reps)
        if(count_perfect_reps == 2){
            return false;
        } else {
            return true;
        }}}
    

    var test = {
    timeline: [map_trial],
    data: {phase: "test"}, 
    timeline_variables: create_timeline_variables()[2],
    randomize_order: true}

// ===========================================================================================================================================
// Delay task - digit span backwards 

  // first two numbers in number_set are practice
  number_set = ["21","75", "14", "62", "185", "814", "9518", "374x", 
"48913", "19485", "9648x1", "529483", "6394x18", "2536x149", "165983648"]

hi = `

Before starting the main task, please complete a brief practice session. 
Press 'Next' to start the practice trials.
`

// instruction page
var instructions_delay_task = {
    type: 'instructions',
    pages: function(){
      pageOne = [`<div style='font-size:20px;'>Good work! You have finished the first card game. <br><br> Now, you will take a break from the cards and complete a number sequence task. <br><br> For each trial, you will have to remember a sequence of numbers presented on the screen one after the other.<br>At the end of each sequence, enter all the numbers <b>*in BACKWARDS order*</b> using the onscreen number-pad. <br><br><u>Example:</u> if the sequence is '7-4-5-1', enter '1-5-4-7' in this exact order.<br><br>`, `<div style='font-size:20px;'>
       <br><b>Note:</b> <br> If the number 10 appears in the sequence, report it as 10 and <b>NOT</b> 01. <br> That is, given the sequence '1-10-9', enter '9-10-1' in this exact order. <br> <br> You will receive feedback after each trial on whether your answer was correct. Please make your responses as quickly and accurately as possible. <br>`,`
       <div style='font-size:20px;'>Before starting the main task, please complete a brief practice session. <br>
Press 'Next' to start the practice trials. </div>`]
      return pageOne
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true
  }

  var pre_delay_task = {
    type: 'instructions',
    pages: function(){
      pageOne = "<div style='font-size:20px;'> Good job! Now, you will start the real task. </div>"
      return [pageOne]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true
  }


  var digit_index = 0

var test_stimuli = {
  type: 'html-keyboard-response',
  stimulus: function(){
    var number = number_set[number_set_index]
    var digit = number[digit_index]
    if (digit == "x"){
      digit = "10"
    }
    var stimuli =  '<div style="font-size:70px;">'+digit+'</div>'
    return stimuli
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000
  }

var display_digits = {
    timeline: [test_stimuli],
    repetitions: 1,
    loop_function: function(data){
        while(digit_index + 1 != number_set[number_set_index].length){
            digit_index += 1
            return true
    }
    digit_index = 0
    return false
}
}

function reverseString(str) {
    var newString = "";
    for (var i = str.length - 1; i >= 0; i--) {
        newString += str[i];
    }
    return newString;
}

var scores = [0,0,]

var recall = {
  type: 'digit-span-recall',
  correct_order: function(){
    return reverseString(number_set[number_set_index])
  },
  trial_duration: 13000,
  sound: "stimuli/button_click_sound.mp4",
  on_finish: function(data){
      var stimuli = reverseString(number_set[number_set_index])
      var score = 0
      for (i = 0; i < number_set[number_set_index]; i++){
        if(typeof data.recall[i] === 'undefined') {
              break;
        // does not exist
        }
        else {
        // does exist
        if (data.recall[i] == stimuli[i]){
            score +=1
        }
        }
            }
        data.score = score
        scores.push(score)
}}

var feedback = {
  type: 'html-keyboard-response',
  stimulus: function(){
    var text = ""
    var accuracy = jsPsych.data.get().last(1).values()[0].accuracy
    if (accuracy==1){
      text += '<div style="font-size:35px; color:rgb(0 220 0)"><b>Correct</div>'
    } else {
      text += '<div style="font-size:35px; color:rgb(240 0 0)"><b>Incorrect</div>'
    }
    //text += '<div style="font-size:30px; color:rgb(0 0 0)"><br><br>New trial starting now.</div>'
    return text
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000
}

var number_set_index = 0

var practice_timeline = {
  timeline: [display_digits, recall, feedback],
  repetitions: 1,
  data: {phase: "practice delay"},
  loop_function: function(data){
    number_set_index +=1
    while(number_set_index != 2){
      return true
    }
    return false
}}

var delay_task_timeline = {
  timeline: [display_digits, recall, feedback],
  repetitions: 1,
  data: {phase: "delay task"},
  loop_function: function(data){
    while(number_set_index+1 != number_set.length && ( number_set_index < 7 || (scores[-1] <= 3 && scores[-2] <=3 ))){
        number_set_index +=1
        return true
    }
    return false
  }
}

digit_span_backwards = {
  timeline: [instructions_delay_task, practice_timeline, pre_delay_task, delay_task_timeline]
}

// ==========================================================================================================================================
// Sending data and forms

function generate_uuid() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}
    
        var send_data = {
        type: 'html-keyboard-response',
        stimulus: 'Saving responses... <br> <br> Do NOT exit the page.',
        choices: jsPsych.NO_KEYS,
        trial_duration: null,
        on_start: function(trial){
          
          var subject_id = generate_uuid()

          var start_time = new Date();

          // get url info
          var url_data = jsPsych.data.urlVariables();


          var phase1_responses = jsPsych.data.get().filter([{phase: 'phase1'}]);
          var phase1_data = {'phase': 'phase1', 'data': phase1_responses.values()};

          var phase2_responses = jsPsych.data.get().filter([{phase: 'phase2'}]);
          var phase2_data = {'phase': 'phase2', 'data': phase2_responses.values()};

          var test_responses = jsPsych.data.get().filter([{phase: 'test'}]);
          var test_data = {'phase': 'test', 'data': test_responses.values()};

          var delay_responses = jsPsych.data.get().filter([{phase: 'delay task'}]);
          var delay_data = {'phase': 'delay task', 'data': delay_responses.values()};

            // organize data into sections
            var end_time = new Date();
            var duration = ((end_time - start_time)/60000).toFixed(2);
            
            var data = {
                /*prolific_id: url_data.PROLIFIC_PID,
                study_id: url_data.STUDY_ID,
                session_id: url_data.SESSION_ID,*/
                experiment: "Spatial_layout",
                repo: "buddingmindslab.github.io",
                subject: subject_id,
                duration: duration,
                date: Date(),
                counterbalancing_group: url_data.exp,
                data: [
                  phase1_data,
                  phase2_data,
                  test_data,
                  delay_data
                ]
            }

            // send data to savejs
            var xhr = new XMLHttpRequest();
            xhr.open('POST','https://savejs.netlify.app/.netlify/functions/savejs');
            xhr.setRequestHeader('Content-Type','application/json');
            xhr.onload = function(){
                if(xhr.status==200){
                    var response=JSON.parse(xhr.responseText);
                    console.log(response.success);
                }
                else {
                    console.log("failed to send data");
                }
            };
            xhr.send(JSON.stringify(data));
            console.log("success sending data");
            trial.trial_duration = 50000
        }
    }


  /********************************************* Conclusion and Debriefing *********************************************/
  var conclusion = {
        type: 'html-button-response',
        choices: ['Continue'],
        stimulus:  "<div style='font-size:20px;'> Congratulations - you have finished the experiment! <br> <br> Please proceed to the debriefing. You will only receive your compensation after clicking <I> Complete the session </I> on the following page.",
        trial_duration: null,
    };  

    // debriefing
    var debriefing = {
        type: 'external-html',
        url: 'debriefing/debriefing.html',
        cont_btn: "start",
        data: {phase: 'debriefing'}
    }
    
    // thank you
    var end_experiment = {
        type: 'html-keyboard-response',
        stimulus: '<p style="font-size:300%; line-height:1.0">Thank you for your participation!</p>',
        trial_duration: 1000,
        choices: jsPsych.ANY_KEYS
    }

    /***************************************************************************************************************************/
    
var consent = null

var check_consent = function(elem) {
  if (document.getElementById('agree_checkbox').checked) {
    return true;
  }
  else {
    alert("If you wish to participate, you must check the box next to the statement 'I agree'");
    return false;
  }
  return false;
};

var consent_page = {
        type: 'external-html',
        url: 'consent.html',
        cont_btn: "start",
        data: {phase: 'consent_form'},
        check_fn: check_consent
    }

    var experiment_timeline = [overview, instructions1, practice, pre_task, video_transition1, phase1,
  instructions_delay_task, practice_timeline ,pre_delay_task ,delay_task_timeline, instructions2, video_transition2, phase2, 
instructions_test, test, conclusion, debriefing, end_experiment]


    jsPsych.init({
    timeline: [consent_page, experiment_timeline],
    preload_images: E.concat(F).concat(practice_set).concat(["stimuli/yellow world.png","stimuli/blue world.png","stimuli/pink world.png",
   "stimuli/instructions.PNG", "stimuli/instructions2.jpg", "stimuli/instructions_non_overlapping.png", 
   "stimuli/instructions_overlapping.png", "stimuli/instructions_pass_card.png"]),
    max_load_time: 180000,
    on_finish: function() { 
      window.location.replace("https://app.prolific.co/submissions/complete?cc=11D45801")
            }  
        });
</script>
</html>
